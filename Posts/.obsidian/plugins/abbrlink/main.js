/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var u=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var L=(o,s,t)=>s in o?u(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t;var T=(o,s)=>{for(var t in s)u(o,t,{get:s[t],enumerable:!0})},A=(o,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of C(s))!y.call(o,i)&&i!==t&&u(o,i,{get:()=>s[i],enumerable:!(e=S(s,i))||e.enumerable});return o};var v=o=>A(u({},"__esModule",{value:!0}),o);var w=(o,s,t)=>(L(o,typeof s!="symbol"?s+"":s,t),t);var F={};T(F,{default:()=>b});module.exports=v(F);var a=require("obsidian");var d=require("obsidian");var g={BUILD_TASK_LIST:1,CHECK_COLLISION:2,RESOLVE_COLLISION:3},l=class{static formatStepMessage(s,t){return`\u6B65\u9AA4 ${s}/${this.TOTAL_STEPS}\uFF1A${t}`}static showStepStatus(s,t,e){new d.Notice(this.formatStepMessage(s,t),e?.timeout)}static showProcessingStatus(s,t,e,i){let n="";s>0&&(n+=`\u6B63\u5728\u4E3A ${s} \u4E2A\u6587\u4EF6\u751F\u6210\u94FE\u63A5`),t>0&&(n+=`${s>0?"\uFF0C":""}\u6B63\u5728\u66F4\u65B0 ${t} \u4E2A\u4E0D\u4E00\u81F4\u957F\u5EA6\u7684\u94FE\u63A5`),new d.Notice(this.formatStepMessage(e,n+"..."),i?.timeout)}static showCollisionCheckStatus(s,t){this.showStepStatus(g.CHECK_COLLISION,`\u6B63\u5728\u68C0\u67E5 Abbrlink \u51B2\u7A81... (\u7B2C ${s}/${t} \u8F6E)`)}static showCollisionResolutionStatus(s,t){t===0?this.showStepStatus(g.RESOLVE_COLLISION,`\u7B2C ${s} \u8F6E\u68C0\u67E5\u672A\u53D1\u73B0\u51B2\u7A81`):(this.showStepStatus(g.CHECK_COLLISION,`\u7B2C ${s} \u8F6E\u68C0\u67E5\u53D1\u73B0 ${t} \u5904\u51B2\u7A81`),this.showStepStatus(g.RESOLVE_COLLISION,`\u6B63\u5728\u89E3\u51B3\u7B2C ${s} \u8F6E\u51B2\u7A81...`))}static showCollisionWarning(s,t,e,i){new d.Notice(`\u8B66\u544A\uFF1A\u7ECF\u8FC7 ${s} \u8F6E\u68C0\u67E5\u540E\u4ECD\u5B58\u5728 ${t} \u5904\u51B2\u7A81\u3002

\u5EFA\u8BAE\u91C7\u53D6\u4EE5\u4E0B\u63AA\u65BD\uFF1A
1. \u589E\u52A0 Abbrlink \u957F\u5EA6\uFF08\u5F53\u524D\uFF1A${e}\uFF0C\u5EFA\u8BAE\uFF1A${i}\uFF09
2. \u51CF\u5C11\u6587\u7AE0\u6570\u91CF
3. \u589E\u52A0\u6700\u5927\u68C0\u67E5\u6B21\u6570

\u60A8\u53EF\u4EE5\u5728\u63D2\u4EF6\u8BBE\u7F6E\u4E2D\u8C03\u6574\u8FD9\u4E9B\u9009\u9879\u3002`,1e4)}};w(l,"TOTAL_STEPS",3);var m=class{#s;#t;#e;constructor(s,t,e){this.#s=s,this.#t=t,this.#e=e}async buildTaskList(){let s=this.#s.getMarkdownFiles(),t=[];for(let e of s){let i=await this.#s.read(e),n=await this.#e(i),r=!!n,h=!!(n&&n.length!==this.#t.hashLength);t.push({file:e,hasAbbrlink:r,hash:n||void 0,needsLengthUpdate:h})}return t}async findHashConflicts(s){let t=new Map;for(let e of s)if(e.hash){let i=t.get(e.hash)||[];i.push(e.file),t.set(e.hash,i)}return Array.from(t.entries()).filter(([e,i])=>i.length>1).map(([e,i])=>({hash:e,files:i}))}filterTasksToProcess(s){return this.#t.skipExisting?s.filter(t=>!t.hasAbbrlink||this.#t.overrideDifferentLength&&t.needsLengthUpdate):s}};var x={hashLength:8,skipExisting:!0,autoGenerate:!1,useRandomMode:!1,checkCollision:!1,maxCollisionChecks:3,overrideDifferentLength:!1},b=class extends a.Plugin{settings;taskManager;async generateRandomHash(){let s=new Uint8Array(32);window.crypto.getRandomValues(s);let t=await window.crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(t)).map(n=>n.toString(16).padStart(2,"0")).join("").substring(0,this.settings.hashLength)}async generateSha256(s){if(this.settings.useRandomMode)return await this.generateRandomHash();let e=new window.TextEncoder().encode(s),i=await window.crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(i)).map(h=>h.toString(16).padStart(2,"0")).join("").substring(0,this.settings.hashLength)}async getExistingAbbrlink(s){let t=s.match(new RegExp(`abbrlink:\\s*([a-fA-F0-9]{${this.settings.hashLength}})`));return t?t[1]:null}async generateUniqueHash(s){return await this.generateSha256(s.basename)}async processFile(s){try{let t=await this.app.vault.read(s);if(await this.getExistingAbbrlink(t)&&this.settings.skipExisting)return;let i=await this.generateUniqueHash(s);await this.app.fileManager.processFrontMatter(s,n=>{n.abbrlink=i})}catch(t){throw console.error(`Error processing file ${s.path}:`,t),t}}async processFilesWithCollisionCheck(s){let t=0,e=!0,i=[...s];for(;e&&t<this.settings.maxCollisionChecks;){t++;for(let r of i)if(!r.hash){let h=await this.generateUniqueHash(r.file);r.hash=h}l.showCollisionCheckStatus(t,this.settings.maxCollisionChecks);let n=await this.taskManager.findHashConflicts(i);if(n.length===0){await Promise.all(i.map(r=>this.app.fileManager.processFrontMatter(r.file,h=>{h.abbrlink=r.hash}))),l.showCollisionResolutionStatus(t,0),e=!1;return}if(l.showCollisionResolutionStatus(t,n.length),await this.resolveConflicts(i),l.showCollisionResolutionStatus(t,0),t===this.settings.maxCollisionChecks&&n.length>0){let r=this.settings.hashLength,h=Math.min(r+4,32);l.showCollisionWarning(t,n.length,r,h),console.log("Abbrlink \u51B2\u7A81\u8BE6\u7EC6\u4FE1\u606F\uFF1A"),n.forEach((c,p)=>{console.log(`\u51B2\u7A81\u7EC4 ${p+1}\uFF1A`),console.log("Abbrlink\uFF1A",c.hash),console.log("\u51B2\u7A81\u6587\u4EF6\uFF1A"),c.files.forEach(k=>{console.log(`- ${k.path}`)})})}}}async processFilesWithoutCollisionCheck(s){await Promise.all(s.map(t=>this.processFile(t.file)))}async resolveConflicts(s){let t=await this.taskManager.findHashConflicts(s);if(t.length!==0){new a.Notice(`\u53D1\u73B0 ${t.length} \u5904 Abbrlink \u51B2\u7A81\uFF0C\u6B63\u5728\u89E3\u51B3...`);for(let e of t){let i=e.files.sort((n,r)=>n.stat.ctime-r.stat.ctime);for(let n=1;n<i.length;n++){let r=i[n],h;do h=await this.generateRandomHash();while(s.some(p=>p.hash===h));let c=s.find(p=>p.file.path===r.path);c&&(c.hash=h)}}new a.Notice("Abbrlink \u51B2\u7A81\u5DF2\u89E3\u51B3\uFF01")}}async processFiles(){l.showStepStatus(g.BUILD_TASK_LIST,"\u6B63\u5728\u6784\u5EFA\u4EFB\u52A1\u5217\u8868...");let s=await this.taskManager.buildTaskList(),t=this.taskManager.filterTasksToProcess(s),e=t.filter(n=>!n.hasAbbrlink).length,i=t.filter(n=>n.needsLengthUpdate).length;l.showProcessingStatus(e,i,g.CHECK_COLLISION),this.settings.checkCollision?await this.processFilesWithCollisionCheck(t):await this.processFilesWithoutCollisionCheck(t),new a.Notice("\u5B8C\u6210\uFF01")}async onload(){await this.loadSettings(),this.taskManager=new m(this.app.vault,this.settings,this.getExistingAbbrlink.bind(this)),this.addRibbonIcon("link","Generate Abbrlinks",async()=>{try{await this.processFiles()}catch(s){new a.Notice("Error generating abbrlinks!"),console.error(s)}}),this.addSettingTab(new f(this.app,this)),this.registerEvent(this.app.vault.on("create",async s=>{if(this.settings.autoGenerate&&s instanceof a.TFile&&s.extension==="md"){let t=this.settings.useRandomMode;this.settings.useRandomMode=!0,await this.processFile(s),this.settings.useRandomMode=t}}))}onunload(){}async loadSettings(){this.settings=Object.assign({},x,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},f=class extends a.PluginSettingTab{plugin;constructor(s,t){super(s,t),this.plugin=t}display(){let{containerEl:s}=this;s.empty(),new a.Setting(s).setName("Abbrlink Length").setDesc("Abbrlink \u7684\u957F\u5EA6 (1-32)\u3002\u5982\u679C\u7ECF\u5E38\u53D1\u751F\u51B2\u7A81\uFF0C\u5EFA\u8BAE\u589E\u52A0 Abbrlink \u957F\u5EA6\u3002\u957F\u5EA6\u8D8A\u957F\uFF0C\u53D1\u751F\u51B2\u7A81\u7684\u6982\u7387\u8D8A\u5C0F\u3002").addSlider(t=>t.setLimits(4,32,4).setValue(this.plugin.settings.hashLength).setDynamicTooltip().onChange(async e=>{this.plugin.settings.hashLength=e,await this.plugin.saveSettings()})),new a.Setting(s).setName("\u81EA\u52A8\u5316").setHeading(),new a.Setting(s).setName("\u8DF3\u8FC7\u5DF2\u6709\u94FE\u63A5").setDesc("\u5982\u679C\u6587\u4EF6\u5DF2\u7ECF\u5305\u542B Abbrlink\uFF0C\u5219\u8DF3\u8FC7").addToggle(t=>t.setValue(this.plugin.settings.skipExisting).onChange(async e=>{this.plugin.settings.skipExisting=e,await this.plugin.saveSettings()})),new a.Setting(s).setName("\u81EA\u52A8\u751F\u6210").setDesc("\u4E3A\u65B0\u521B\u5EFA\u7684 Markdown \u6587\u4EF6\u81EA\u52A8\u751F\u6210 Abbrlink").addToggle(t=>t.setValue(this.plugin.settings.autoGenerate).onChange(async e=>{this.plugin.settings.autoGenerate=e,await this.plugin.saveSettings()})),new a.Setting(s).setName("\u9AD8\u7EA7\u9009\u9879").setHeading(),new a.Setting(s).setName("\u968F\u673A\u6A21\u5F0F").setDesc("\u4F7F\u7528\u968F\u673A\u751F\u6210\u7684 SHA256 \u4F5C\u4E3A Abbrlink").addToggle(t=>t.setValue(this.plugin.settings.useRandomMode).onChange(async e=>{this.plugin.settings.useRandomMode=e,await this.plugin.saveSettings()})),new a.Setting(s).setName("\u51B2\u7A81\u68C0\u67E5").setDesc("\u5F53\u68C0\u6D4B\u5230 Abbrlink \u51B2\u7A81\u65F6\uFF0C\u81EA\u52A8\u5207\u6362\u5230\u968F\u673A\u6A21\u5F0F\u91CD\u65B0\u751F\u6210").addToggle(t=>t.setValue(this.plugin.settings.checkCollision).onChange(async e=>{this.plugin.settings.checkCollision=e,await this.plugin.saveSettings()})),new a.Setting(s).setName("\u6700\u5927\u51B2\u7A81\u68C0\u67E5\u6B21\u6570").setDesc("\u5F53\u5F00\u542F\u51B2\u7A81\u68C0\u67E5\u65F6\uFF0C\u6700\u591A\u91CD\u590D\u68C0\u67E5\u7684\u6B21\u6570 (1-10)").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.maxCollisionChecks).setDynamicTooltip().onChange(async e=>{this.plugin.settings.maxCollisionChecks=e,await this.plugin.saveSettings()})),new a.Setting(s).setName("\u8986\u76D6\u4E0D\u540C\u957F\u5EA6\u7684\u94FE\u63A5").setDesc("\u5F53\u6587\u4EF6\u7684\u94FE\u63A5\u957F\u5EA6\u4E0E\u5F53\u524D\u8BBE\u7F6E\u4E0D\u4E00\u65F6\uFF0C\u91CD\u65B0\u751F\u6210\u8BE5\u94FE\u63A5").addToggle(t=>t.setValue(this.plugin.settings.overrideDifferentLength).onChange(async e=>{this.plugin.settings.overrideDifferentLength=e,await this.plugin.saveSettings()}))}};
