/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var d=Object.create;var l=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var y=(i,e)=>{for(var t in e)l(i,t,{get:e[t],enumerable:!0})},u=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of m(e))!w.call(i,a)&&a!==t&&l(i,a,{get:()=>e[a],enumerable:!(s=b(e,a))||s.enumerable});return i};var v=(i,e,t)=>(t=i!=null?d(k(i)):{},u(e||!i||!i.__esModule?l(t,"default",{value:i,enumerable:!0}):t,i)),x=i=>u(l({},"__esModule",{value:!0}),i);var f={};y(f,{default:()=>h});module.exports=x(f);var n=require("obsidian"),o=v(require("crypto")),E={hashLength:8,skipExisting:!0,autoGenerate:!1,useRandomMode:!1,checkCollision:!0},h=class extends n.Plugin{settings;generateRandomHash(){let t=o.generateKeyPairSync("ed25519").publicKey.export({type:"spki",format:"der"});return o.createHash("sha256").update(t).digest("hex").substring(0,this.settings.hashLength)}generateSha256(e){return this.settings.useRandomMode?this.generateRandomHash():o.createHash("sha256").update(e).digest("hex").substring(0,this.settings.hashLength)}async getExistingAbbrlink(e){let t=e.match(new RegExp(`abbrlink:\\s*([a-fA-F0-9]{${this.settings.hashLength}})`));return t?t[1]:null}async isHashExisting(e,t){let s=this.app.vault.getMarkdownFiles(),a=await Promise.all(s.map(r=>this.app.vault.read(r)));for(let r=0;r<s.length;r++){if(s[r].path===t.path)continue;if(await this.getExistingAbbrlink(a[r])===e)return!0}return!1}async generateUniqueHash(e){let t=this.generateSha256(e.basename);if(this.settings.checkCollision&&await this.isHashExisting(t,e)){console.log(`Hash collision detected for ${e.path}, using random mode`);do t=this.generateRandomHash();while(await this.isHashExisting(t,e))}return t}async processFile(e){try{let t=await this.app.vault.read(e);if(t.includes("abbrlink:")&&this.settings.skipExisting)return;let s=await this.generateUniqueHash(e),a;if(t.startsWith("---")){let r=t.split("---"),g=r[1].startsWith(`
`)?r[1]:`
`+r[1];a=`---${g.includes("abbrlink:")?g.replace(/abbrlink:.*/,`abbrlink: ${s}`):`${g.trimEnd()}
abbrlink: ${s}
`}---${r.slice(2).join("---")}`}else a=`---
abbrlink: ${s}
---
${t}`;await this.app.vault.modify(e,a)}catch(t){throw console.error(`Error processing file ${e.path}:`,t),t}}async onload(){await this.loadSettings(),this.addRibbonIcon("link","Generate Abbrlinks",async e=>{try{new n.Notice("Processing files...");let t=this.app.vault.getMarkdownFiles();await Promise.all(t.map(s=>this.processFile(s))),new n.Notice("Abbrlinks generated successfully!")}catch(t){new n.Notice("Error generating abbrlinks!"),console.error(t)}}),this.addSettingTab(new c(this.app,this)),this.registerEvent(this.app.vault.on("create",async e=>{if(this.settings.autoGenerate&&e instanceof n.TFile&&e.extension==="md"){let t=this.settings.useRandomMode;this.settings.useRandomMode=!0,await this.processFile(e),this.settings.useRandomMode=t}}))}onunload(){}async loadSettings(){this.settings=Object.assign({},E,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},c=class extends n.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Abbrlink"}),e.createEl("h3",{text:"\u57FA\u672C\u8BBE\u7F6E"}),new n.Setting(e).setName("Abbrlink \u957F\u5EA6").setDesc("Abbrlink \u957F\u5EA6 (4-32)").addSlider(t=>t.setLimits(4,32,4).setValue(this.plugin.settings.hashLength).setDynamicTooltip().onChange(async s=>{this.plugin.settings.hashLength=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u81EA\u52A8\u5316\u9009\u9879"}),new n.Setting(e).setName("\u8DF3\u8FC7\u5DF2\u6709\u94FE\u63A5").setDesc("\u5982\u679C\u6587\u4EF6\u5DF2\u7ECF\u5305\u542B\u7F29\u7565\u94FE\u63A5\uFF0C\u5219\u8DF3\u8FC7\u5904\u7406").addToggle(t=>t.setValue(this.plugin.settings.skipExisting).onChange(async s=>{this.plugin.settings.skipExisting=s,await this.plugin.saveSettings()})),new n.Setting(e).setName("\u81EA\u52A8\u751F\u6210").setDesc("\u4E3A\u65B0\u521B\u5EFA\u7684 Markdown \u6587\u4EF6\u81EA\u52A8\u751F\u6210\u7F29\u7565\u94FE\u63A5").addToggle(t=>t.setValue(this.plugin.settings.autoGenerate).onChange(async s=>{this.plugin.settings.autoGenerate=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u9AD8\u7EA7\u9009\u9879"}),new n.Setting(e).setName("\u968F\u673A\u6A21\u5F0F").setDesc("\u4F7F\u7528\u968F\u673A\u751F\u6210\u7684 SHA256 \u54C8\u5E0C\u503C\u4F5C\u4E3A\u7F29\u7565\u94FE\u63A5\uFF0C\u800C\u4E0D\u662F\u57FA\u4E8E\u6587\u4EF6\u540D\u751F\u6210").addToggle(t=>t.setValue(this.plugin.settings.useRandomMode).onChange(async s=>{this.plugin.settings.useRandomMode=s,await this.plugin.saveSettings()})),new n.Setting(e).setName("\u68C0\u67E5\u54C8\u5E0C\u51B2\u7A81").setDesc("\u5F53\u68C0\u6D4B\u5230\u54C8\u5E0C\u503C\u51B2\u7A81\u65F6\uFF0C\u81EA\u52A8\u5207\u6362\u5230\u968F\u673A\u6A21\u5F0F\u91CD\u65B0\u751F\u6210").addToggle(t=>t.setValue(this.plugin.settings.checkCollision).onChange(async s=>{this.plugin.settings.checkCollision=s,await this.plugin.saveSettings()}))}};
